{
  "name": "CICD/mailOnCommit",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "6a454f38-091e-44be-ba6f-eeb5b8dc9deb",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -40,
        -120
      ],
      "id": "d00fd797-b52f-4784-9108-48cdd9dc5875",
      "name": "Webhook",
      "webhookId": "6a454f38-091e-44be-ba6f-eeb5b8dc9deb"
    },
    {
      "parameters": {
        "fromEmail": "abelix.pouillet@gmail.com",
        "toEmail": "abelix.pouillet@gmail.com",
        "subject": "=Commit {{ $('Webhook').item.json.body.author }} sur {{ $('Webhook').item.json.body.repo }}",
        "html": "={{ $json.html }}",
        "options": {}
      },
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [
        760,
        -120
      ],
      "id": "8a6c4448-f373-4cd8-815b-8bcefb6500af",
      "name": "Send Email",
      "webhookId": "9ceae8f2-5bae-4fe3-939d-7c59a4ccfb6a",
      "credentials": {
        "smtp": {
          "id": "FBM6adQ397Tdiwdl",
          "name": "SMTP account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Voici les informations d‚Äôun commit √† analyser. G√©n√©re un rapport d‚Äôanalyse en HTML selon le format sp√©cifi√© dans le message syst√®me. Tu d√©taillera la place du commit dans le projet en analysant les fichiers concern√©s par les modifications via ton tool github\n\nCommit :\n- RepoUrl : {{ $json.body.owner }}\n- Hash : {{ $json.body.commit }}\n- Auteur : {{ $json.body.author }}\n- Message : {{ $json.body.message }}\n\nFichiers modifi√©s :\n{{ $json.body.files }}\n\nDiff :\n{{ $json.body.diff }}\n\nFormate ta r√©ponse uniquement comme une pr√©sentation html\n\"<html><h2>Analyse du Commit : {{ $json.body.commit }}</h2>...</html>\"\n\nN‚Äôutilise aucun commentaire ou texte en dehors de ce bloc html",
        "options": {
          "systemMessage": "=Tu es un assistant IA sp√©cialis√© dans l‚Äôanalyse de commits Git, la gestion du tools github, et la r√©daction automatique de rapports professionnels en HTML.\n\n\nTu re√ßois, pour chaque commit, les informations suivantes :\n\ncommit: \nRepoUrl (important pour utiliser le tool github)\nhash du commit,\n\nmessage: message du commit,\n\nauthor: auteur du commit,\n\nfiles: liste des fichiers modifi√©s (avec leur statut : A=ajout, M=modif, D=suppression),\n\ndiff: contenu textuel des modifications (diff Git),\n\nTu dois √©galement acc√©der au contenu complet des fichiers du d√©p√¥t via un outil GitHub, pour mieux comprendre le contexte et pr√©ciser la place du commit dans le projet dans ta r√©ponse.\nPour cela tu va devoir configurer le tool Github tool qui t'est associ√©.\nEn l'appelant une fois par fichier modifi√©s dans le commit avec les coordonn√©es du repos : {{ $json.body.repo }} de {{ $json.body.owner }}\n\n\nTon objectif est de r√©diger un email au format HTML destin√© √† une √©quipe technique. Cet email doit :\n\ncontenir un r√©sum√© professionnel des changements apport√©s,\n\nanalyser bri√®vement les impacts techniques ou fonctionnels,\n\nsignaler toute anomalie potentielle (code incomplet, mauvaise pratique, manque de tests, nommage ambigu, etc.),\n\nproposer des recommandations si besoin,\n\n√™tre structur√© clairement avec des sections, une hi√©rarchie visuelle, et un ton professionnel.\n\nL‚Äôemail doit √™tre √©crit en HTML pur, sans CSS externe, pour √™tre compatible avec les clients mails standards.\n\nVoici la structure attendue :\n\n\n<h2>Analyse du Commit : [hash court]</h2>\n<p><strong>Auteur :</strong> [Nom de l‚Äôauteur]</p>\n<p><strong>Message :</strong> [Message du commit]</p>\n\n<h3>R√©sum√© des Changements</h3>\n<ul>\n  <li>[Ex : Ajout de la gestion des erreurs dans le module de paiement]</li>\n  ...\n</ul>\n\n<h3>D√©tails Techniques</h3>\n<ul>\n  <li>Fichiers modifi√©s : [Liste + type de changement]</li>\n  <li>Fonctions ou classes impact√©es (si identifiable)</li>\n  <li>Tests associ√©s (pr√©sents / absents / √† recommander)</li>\n</ul>\n\n<h3>Recommandations</h3>\n<ul>\n  <li>[Ex : Ajouter des tests unitaires pour la fonction `processPayment()`]</li>\n  ...\n</ul>\n\n<h3>Niveau de S√©v√©rit√©</h3>\n<p><strong>[Faible / Moyenne / √âlev√©e]</strong> ‚Äì selon l‚Äôimpact potentiel du commit</p>\nR√©dige le contenu de mani√®re concise, utile et lisible. Ne g√©n√®re que le corps HTML de l‚Äôemail, sans balises <html>, <head>, ou <body>.\n\nUne analyse correcte du commit n√©cessite de conna√Ætre le contenu complet d‚Äôun fichier, tu DOIS utiliser l‚Äôoutil GitHub pour le r√©cup√©rer. Tu as acc√®s √† ce tool via les variables suivantes :\n- Repository_Owner\n- Repository_Name\n- File_Path\n- Reference (commit hash)\n\nAvant de r√©diger la section ‚ÄúD√©tails Techniques‚Äù, v√©rifie si tu dois consulter le code d‚Äôun ou plusieurs fichiers modifi√©s.\n\nUTILISATION DU TOOL GITHUB \nüß∞ N≈ìud GitHub ‚Äì Obtenir un fichier (File ‚Üí Get)\nDescription :\nCe n≈ìud permet √† un agent IA d‚Äôacc√©der directement au contenu d‚Äôun fichier sp√©cifique dans un d√©p√¥t GitHub. Il est particuli√®rement utile pour analyser des fichiers de configuration, des scripts ou des documents, et peut √™tre int√©gr√© dans des workflows d‚Äôautomatisation ou d‚Äôanalyse.\n\n‚öôÔ∏è Param√®tres requis\nRepository Owner : Nom d'utilisateur ou organisation propri√©taire du d√©p√¥t (ex. : openai).\n\nRepository Name : Nom du d√©p√¥t (ex. : chatgpt).\n\nFile Path : Chemin relatif du fichier dans le d√©p√¥t (ex. : src/index.js).\n\nBranch : Branche √† partir de laquelle r√©cup√©rer le fichier (par d√©faut : main)."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.9,
      "position": [
        220,
        -120
      ],
      "id": "974b38e3-9294-4248-89cf-ee732d2129f2",
      "name": "AI Agent",
      "alwaysOutputData": true,
      "notesInFlow": true,
      "onError": "continueRegularOutput",
      "notes": "Agent qui reprend les info du post et du repo"
    },
    {
      "parameters": {
        "model": "qwen3:32b",
        "options": {
          "numCtx": 4096
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOllama",
      "typeVersion": 1,
      "position": [
        120,
        220
      ],
      "id": "08e9cfbd-70e0-41f0-9425-81600f7d0adc",
      "name": "Ollama Chat Model",
      "credentials": {
        "ollamaApi": {
          "id": "RT5eWMAdPQ1quh6W",
          "name": "Ollama account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// R√©cup√©rer la sortie du parser\nlet rawHtml = $input.first().json.output\n\nrawHtml = rawHtml.replace(/<think>[\\s\\S]*?<\\/think>/gi, '');\n// Remplacer les \\n (retours √† la ligne bruts) par un espace ou rien\nrawHtml = rawHtml.replace(/\\\\n/g, ' ');\n\n// Optionnel : compacter les espaces multiples\nrawHtml = rawHtml.replace(/\\s{2,}/g, ' ');\n\nrawHtml = rawHtml.replace(/\\\\n/g, ' ');\n\nrawHtml = rawHtml.replace(/\\s{2,}/g, ' ');\n\nrawHtml = rawHtml.replace(/\\\\n/g, ' ');\n// Retourner la version nettoy√©e\nreturn [{ json: { html: rawHtml.trim() } }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        580,
        -120
      ],
      "id": "ff42dc60-f464-42cc-9be8-2826f2ebb00c",
      "name": "Code",
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Webhook').item.json.body.owner }}"
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        320,
        220
      ],
      "id": "327a6b07-e5fe-4bc2-a7b8-100542ce267a",
      "name": "Simple Memory"
    },
    {
      "parameters": {
        "resource": "repository",
        "operation": "get",
        "owner": {
          "__rl": true,
          "mode": "url",
          "value": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Repository_Owner', ``, 'string') }}",
          "__regex": "https:\\/\\/github.com\\/([-_0-9a-zA-Z]+)"
        },
        "repository": {
          "__rl": true,
          "value": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Repository_Name', `üß∞ N≈ìud GitHub ‚Äì Obtenir un fichier (File ‚Üí Get)\nDescription :\nCe n≈ìud permet √† un agent IA d‚Äôacc√©der directement au contenu d‚Äôun fichier sp√©cifique dans un d√©p√¥t GitHub. Il est particuli√®rement utile pour analyser des fichiers de configuration, des scripts ou des documents, et peut √™tre int√©gr√© dans des workflows d‚Äôautomatisation ou d‚Äôanalyse.\n\n‚öôÔ∏è Param√®tres requis\nRepository Owner : Nom d'utilisateur ou organisation propri√©taire du d√©p√¥t (ex. : openai).\n\nRepository Name : Nom du d√©p√¥t (ex. : chatgpt).\n\nFile Path : Chemin relatif du fichier dans le d√©p√¥t (ex. : src/index.js).\n\nBranch : Branche √† partir de laquelle r√©cup√©rer le fichier (par d√©faut : main).`, 'string') }}",
          "mode": "url"
        }
      },
      "type": "n8n-nodes-base.githubTool",
      "typeVersion": 1.1,
      "position": [
        500,
        120
      ],
      "id": "59061633-8a54-4cc7-a58e-48ed5983f3f5",
      "name": "GitHub",
      "webhookId": "b7628c80-b4db-4be3-93ff-38b6840fe9f6",
      "credentials": {
        "githubApi": {
          "id": "XjwmT75p82us4KPF",
          "name": "GitHub account"
        }
      }
    }
  ],
  "pinData": {},
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ollama Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Code": {
      "main": [
        [
          {
            "node": "Send Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "GitHub": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "ce58cdf3-45b3-4091-a04c-c54fb100c9ae",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "1fef9298adbdb1d370432ac0c9ccd053fbae040f73201c010b72e6aa0ca09017"
  },
  "id": "g1PM4k7CPmJtpgD5",
  "tags": []
}